#!/usr/bin/env ruby
require 'rubygems'
require 'curb'

browser = ENV['BROWSER'] ? ENV['BROWSER'] : 'xdg-open'
clipcmd = "echo -n %s | xclip -selection clipboard"

scheme = '%Y-%m-%d-%s.png'
location = '~/images/'

path = `scrot -s '#{scheme}' -e 'mv $f #{location}$f; echo -n #{location}$f'`
abort("Did not capture screenshot") unless path != ""


c = Curl::Easy.new("http://gyazo.com/upload.cgi")
c.multipart_form_post = true

c.on_success do | data |
  system "#{clipcmd % [data.body_str]}"
  system "#{browser} '#{data.body_str}' >/dev/null 2>&1"
end

c.on_failure do | data |
  # will update next time gyazo is down.
  # if anyone is using this, feel free to submit a pull request
  puts data.methods.sort # temporary
end

c.http_post(Curl::PostField.file('imagedata', "#{path}"))